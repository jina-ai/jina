<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex/" /><link rel="search" title="Search" href="../../../../search/" />
        <link rel="canonical" href="https://docs.jina.ai/_modules/jina/orchestrate/deployments.html" />

    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/><!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>jina.orchestrate.deployments - Jina 3.24.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/docbot.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: #4d4d4d;
  --color-brand-primary: #009191;
  --color-brand-content: #009191;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
    <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
    <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
    <header class="mobile-header">
        <div class="header-left">
            <label class="nav-overlay-icon" for="__navigation">
                <div class="visually-hidden">Toggle site navigation sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-menu"></use>
                    </svg>
                </i>
            </label>
        </div>
        <div class="header-center">
            <a href="../../../../">
                <div class="brand">Jina 3.24.0 documentation</div>
            </a>
        </div>
        <div class="header-right">
            <div class="theme-toggle-container theme-toggle-header">
                <button class="theme-toggle">
                    <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                    <svg class="theme-icon-when-auto">
                        <use href="#svg-sun-half"></use>
                    </svg>
                    <svg class="theme-icon-when-dark">
                        <use href="#svg-moon"></use>
                    </svg>
                    <svg class="theme-icon-when-light">
                        <use href="#svg-sun"></use>
                    </svg>
                </button>
            </div>
            <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
                <div class="visually-hidden">Toggle table of contents sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-toc"></use>
                    </svg>
                </i>
            </label>
        </div>
    </header>
    <aside class="sidebar-drawer">
        <div class="sidebar-container">
            
            <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../../_static/logo-light.svg" alt="Light Logo" />
    <img class="sidebar-logo only-dark" src="../../../../_static/logo-dark.svg" alt="Dark Logo" />
  </div>
  
  
</a>
<script>
  function setPrefix(prefix){
    window.location.href = prefix
  }
</script>
<script defer>
  fetch(`https://${window.location.host}/_versions.json`)
  .then((resp) => resp.json())
  .then((data) => {
    var versionSelector = document.getElementsByClassName("version-select")[0];
    var currentPrefix = window.location.href.toString().split(window.location.host)[1].split('/')[1];

    for(var i = 0; i < data.length; i++){
      var option = document.createElement("option");
      option.innerHTML = data[i].version;
      option.value = "/" + data[i].version;
      versionSelector.appendChild(option);
      if(currentPrefix === data[i].version){
        versionSelector.selectedIndex = i + 1;
      }
    }
  })
  .catch((err) => console.log(err));
</script>
<div class="sd-d-flex-row sd-align-major-spaced">
  <a class="github-button" href="https://github.com/jina-ai/jina" data-icon="octicon-star" data-show-count="true" aria-label="Star jina-ai/jina on GitHub" style="opacity: 0;">Star</a>
  <select onChange="setPrefix(this.value)" class="version-select">
    <option value="/">latest</option>
  </select>
</div><form class="sidebar-search-container" method="get" action="../../../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
    <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../get-started/install/"><svg aria-hidden="true" class="sd-octicon sd-octicon-desktop-download" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4.927 5.427l2.896 2.896a.25.25 0 00.354 0l2.896-2.896A.25.25 0 0010.896 5H8.75V.75a.75.75 0 10-1.5 0V5H5.104a.25.25 0 00-.177.427z"></path><path d="M1.573 2.573a.25.25 0 00-.073.177v7.5a.25.25 0 00.25.25h12.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-3a.75.75 0 110-1.5h3A1.75 1.75 0 0116 2.75v7.5A1.75 1.75 0 0114.25 12h-3.727c.099 1.041.52 1.872 1.292 2.757A.75.75 0 0111.25 16h-6.5a.75.75 0 01-.565-1.243c.772-.885 1.192-1.716 1.292-2.757H1.75A1.75 1.75 0 010 10.25v-7.5A1.75 1.75 0 011.75 1h3a.75.75 0 010 1.5h-3a.25.25 0 00-.177.073zM6.982 12a5.72 5.72 0 01-.765 2.5h3.566a5.72 5.72 0 01-.765-2.5H6.982z"></path></svg> Install</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../get-started/install/docker/">Via Docker Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../get-started/install/apple-silicon-m1-m2/">On Apple Silicon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../get-started/install/windows/">On Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../get-started/install/troubleshooting/">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get-started/create-app/"><span class="fas fa-folder-plus"></span> Create First Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../concepts/preliminaries/"><span class="fas fa-egg"></span> Preliminaries</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/preliminaries/coding-in-python-yaml/">Coding in Python/YAML</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../concepts/serving/"><span class="fas fa-gears"></span> Serving</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../concepts/serving/executor/">Executor</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/create/">Create</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/add-endpoints/">Add Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/serve/">Serve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/dynamic-batching/">Dynamic Batching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/health-check/">Health Check</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hot-reload/">Hot Reload</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/file-structure/">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/containerize/">Containerize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/instrumentation/">Instrumentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/yaml-spec/"><svg aria-hidden="true" class="sd-octicon sd-octicon-file-code" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0114.25 15h-9a.75.75 0 010-1.5h9a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 0110 4.25V1.5H5.75a.25.25 0 00-.25.25v2.5a.75.75 0 01-1.5 0v-2.5zm7.5-.188V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM5.72 6.72a.75.75 0 000 1.06l1.47 1.47-1.47 1.47a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2a.75.75 0 00-1.06 0zM3.28 7.78a.75.75 0 00-1.06-1.06l-2 2a.75.75 0 000 1.06l2 2a.75.75 0 001.06-1.06L1.81 9.25l1.47-1.47z" fill-rule="evenodd"></path></svg> YAML specification</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../concepts/serving/gateway/">Gateway</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/gateway/health-check/">Health Check</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/gateway/rate-limit/">Rate Limit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/gateway/customize-http-endpoints/">Customize HTTP endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/gateway/customization/">Customization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/gateway/yaml-spec/"><svg aria-hidden="true" class="sd-octicon sd-octicon-file-code" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0114.25 15h-9a.75.75 0 010-1.5h9a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 0110 4.25V1.5H5.75a.25.25 0 00-.25.25v2.5a.75.75 0 01-1.5 0v-2.5zm7.5-.188V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM5.72 6.72a.75.75 0 000 1.06l1.47 1.47-1.47 1.47a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2a.75.75 0 00-1.06 0zM3.28 7.78a.75.75 0 00-1.06-1.06l-2 2a.75.75 0 000 1.06l2 2a.75.75 0 001.06-1.06L1.81 9.25l1.47-1.47z" fill-rule="evenodd"></path></svg> YAML specification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../concepts/orchestration/"><span class="fas fa-network-wired"></span> Orchestration</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/deployment/">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/flow/">Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/add-executors/">Add Executors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/scale-out/">Scale Out</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/hot-reload/">Hot Reload</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/handle-exceptions/">Handle Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/readiness/">Readiness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/health-check/">Health Check</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/instrumentation/">Instrumentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/troubleshooting-on-multiprocess/">Troubleshooting on Multiprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/orchestration/yaml-spec/"><svg aria-hidden="true" class="sd-octicon sd-octicon-file-code" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0114.25 15h-9a.75.75 0 010-1.5h9a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 0110 4.25V1.5H5.75a.25.25 0 00-.25.25v2.5a.75.75 0 01-1.5 0v-2.5zm7.5-.188V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM5.72 6.72a.75.75 0 000 1.06l1.47 1.47-1.47 1.47a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2a.75.75 0 00-1.06 0zM3.28 7.78a.75.75 0 00-1.06-1.06l-2 2a.75.75 0 000 1.06l2 2a.75.75 0 001.06-1.06L1.81 9.25l1.47-1.47z" fill-rule="evenodd"></path></svg> YAML specification</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../concepts/client/"><span class="fas fa-laptop-code"></span> Client</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/send-receive-data/">Send &amp; Receive Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/send-parameters/">Send Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/send-graphql-mutation/">Send GraphQL Mutation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/transient-errors/">Transient Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/callbacks/">Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/rate-limit/">Rate Limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/instrumentation/">Instrumentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../concepts/client/third-party-clients/">Third-party clients</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cloud Native</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../cloud-nativeness/k8s/"><span class="fas fa-dharmachakra"></span> Kubernetes Support</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../cloud-nativeness/kubernetes/">Deploy on Kubernetes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloud-nativeness/docker-compose/"><span class="fab fa-docker"></span> Docker Compose Support</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../cloud-nativeness/opentelemetry/"><svg aria-hidden="true" class="sd-octicon sd-octicon-telescope-fill" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M8.531 10.21a.75.75 0 01.944.253l2.644 3.864a.75.75 0 11-1.238.847L9 12.424v2.826a.75.75 0 01-1.5 0v-2.826l-1.881 2.75a.75.75 0 01-1.238-.848l2.048-2.992a.75.75 0 01.293-.252l1.81-.871zM11.905.42a1.5 1.5 0 012.144.49l1.692 2.93a1.5 1.5 0 01-.649 2.102L2.895 11.815a1.5 1.5 0 01-1.95-.602l-.68-1.176a1.5 1.5 0 01.455-1.99L11.905.422zM3.279 8.119l.835 1.445 1.355-.653-.947-1.64-1.243.848zm7.728-1.874L9.6 3.808l1.243-.848 1.52 2.631-1.356.653z" fill-rule="evenodd"></path></svg> OpenTelemetry Support</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../cloud-nativeness/opentelemetry-migration/">Migrate from Prometheus/Grafana to OpenTelemetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cloud-nativeness/monitoring/">Prometheus/Grafana Support (Legacy)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../jina-ai-cloud/"><svg aria-hidden="true" class="sd-octicon sd-octicon-beaker" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M5 5.782V2.5h-.25a.75.75 0 010-1.5h6.5a.75.75 0 010 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458L5 5.782zM9.5 2.5h-3V6a.75.75 0 01-.117.403L4.73 9h6.54L9.617 6.403A.75.75 0 019.5 6V2.5zm-6.9 9.847L3.775 10.5h8.45l1.175 1.847a.75.75 0 01-.633 1.153H3.233a.75.75 0 01-.633-1.153z" fill-rule="evenodd"></path></svg> Jina AI Cloud</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../jina-ai-cloud/login/">Login &amp; Token Management</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../concepts/serving/executor/hub/">Executor Hub</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hub/hub-portal/">Portal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hub/create-hub-executor/">Create</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hub/push-executor/">Publish</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hub/use-hub-executor/">Use</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/serving/executor/hub/debug-executor/">Debug</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../concepts/jcloud/">Jina AI Cloud Hosting</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../concepts/jcloud/configuration/"><svg aria-hidden="true" class="sd-octicon sd-octicon-file-code" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0114.25 15h-9a.75.75 0 010-1.5h9a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 0110 4.25V1.5H5.75a.25.25 0 00-.25.25v2.5a.75.75 0 01-1.5 0v-2.5zm7.5-.188V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM5.72 6.72a.75.75 0 000 1.06l1.47 1.47-1.47 1.47a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2a.75.75 0 00-1.06 0zM3.28 7.78a.75.75 0 00-1.06-1.06l-2 2a.75.75 0 000 1.06l2 2a.75.75 0 001.06-1.06L1.81 9.25l1.47-1.47z" fill-rule="evenodd"></path></svg> Configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api-rst/"><span class="fab fa-python"></span> Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli/"><svg aria-hidden="true" class="sd-octicon sd-octicon-terminal" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25V2.75zm1.75-.25a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V2.75a.25.25 0 00-.25-.25H1.75zM7.25 8a.75.75 0 01-.22.53l-2.25 2.25a.75.75 0 11-1.06-1.06L5.44 8 3.72 6.28a.75.75 0 111.06-1.06l2.25 2.25c.141.14.22.331.22.53zm1.5 1.5a.75.75 0 000 1.5h3a.75.75 0 000-1.5h-3z" fill-rule="evenodd"></path></svg> Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../yaml-spec/"><svg aria-hidden="true" class="sd-octicon sd-octicon-file-code" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M4 1.75C4 .784 4.784 0 5.75 0h5.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v8.586A1.75 1.75 0 0114.25 15h-9a.75.75 0 010-1.5h9a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 0110 4.25V1.5H5.75a.25.25 0 00-.25.25v2.5a.75.75 0 01-1.5 0v-2.5zm7.5-.188V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM5.72 6.72a.75.75 0 000 1.06l1.47 1.47-1.47 1.47a.75.75 0 101.06 1.06l2-2a.75.75 0 000-1.06l-2-2a.75.75 0 00-1.06 0zM3.28 7.78a.75.75 0 00-1.06-1.06l-2 2a.75.75 0 000 1.06l2 2a.75.75 0 001.06-1.06L1.81 9.25l1.47-1.47z" fill-rule="evenodd"></path></svg> YAML Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../envs/"><svg aria-hidden="true" class="sd-octicon sd-octicon-list-unordered" height="1.0em" version="1.1" viewbox="0 0 16 16" width="1.0em"><path d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z" fill-rule="evenodd"></path></svg> Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../telemetry/"><span class="fas fa-tower-cell"></span> Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../proto/docs/">Protocol Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docarray-support/">DocArray support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/deploy-model/">Deploy a model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/gpu-executor/">Build a GPU Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/llm-serve/">Build a Streaming API for a Large Language Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Legacy Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://docs2.jina.ai/">Jina 2 Documentation</a></li>
</ul>

    <p class="caption" role="heading"><span class="caption-text">Ecosystem</span></p>
    <ul>
        <li class="toctree-l1">
            <a class="reference internal" href="#">
                <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/search-light.svg">
                <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/search-dark.svg">
                Jina</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://cloud.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/hub-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/hub-dark.svg">
            Jina Hub</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://finetuner.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/finetuner-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/finetuner-dark.svg">
            Finetuner</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://docs.docarray.org">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/docarray-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/docarray-dark.svg">
            DocArray</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://clip-as-service.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/cas-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/cas-dark.svg">
            CLIP-as-service</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://github.com/jina-ai/jcloud">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/JCloud-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/JCloud-dark.svg">
            JCloud</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://now.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../../../_static/now-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../../../_static/now-dark.svg">
            NOW</a></li>
    </ul>
</div>

</div>

            </div>
            
        </div>
    </aside>
    <div class="main">
        <div class="content">
            <div class="article-container">
                <a href="#" class="back-to-top muted-link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
                    </svg>
                    <span>Back to top</span>
                </a>
                <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
                        <button class="theme-toggle">
                            <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                            <svg class="theme-icon-when-auto">
                                <use href="#svg-sun-half"></use>
                            </svg>
                            <svg class="theme-icon-when-dark">
                                <use href="#svg-moon"></use>
                            </svg>
                            <svg class="theme-icon-when-light">
                                <use href="#svg-sun"></use>
                            </svg>
                        </button>
                    </div>
                    <label class="toc-overlay-icon toc-content-icon no-toc"
                           for="__toc">
                        <div class="visually-hidden">Toggle table of contents sidebar</div>
                        <i class="icon">
                            <svg>
                                <use href="#svg-toc"></use>
                            </svg>
                        </i>
                    </label>
                </div>
                <article role="main">
                    <h1>Source code for jina.orchestrate.deployments</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">overload</span>

<span class="kn">from</span> <span class="nn">hubble.executor.helper</span> <span class="kn">import</span> <span class="n">replace_secret_of_hub_uri</span>
<span class="kn">from</span> <span class="nn">rich</span> <span class="kn">import</span> <span class="nb">print</span>
<span class="kn">from</span> <span class="nn">rich.panel</span> <span class="kn">import</span> <span class="n">Panel</span>

<span class="kn">from</span> <span class="nn">jina.clients</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">jina.clients.mixin</span> <span class="kn">import</span> <span class="n">PostMixin</span>
<span class="kn">from</span> <span class="nn">jina.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">__default_executor__</span><span class="p">,</span>
    <span class="n">__default_grpc_gateway__</span><span class="p">,</span>
    <span class="n">__default_host__</span><span class="p">,</span>
    <span class="n">__docker_host__</span><span class="p">,</span>
    <span class="n">__windows__</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jina.enums</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DeploymentRoleType</span><span class="p">,</span>
    <span class="n">PodRoleType</span><span class="p">,</span>
    <span class="n">PollingType</span><span class="p">,</span>
    <span class="n">ProtocolType</span><span class="p">,</span>
    <span class="n">ProviderType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jina.helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ArgNamespace</span><span class="p">,</span>
    <span class="n">parse_host_scheme</span><span class="p">,</span>
    <span class="n">random_port</span><span class="p">,</span>
    <span class="n">send_telemetry_event</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jina.importer</span> <span class="kn">import</span> <span class="n">ImportExtensions</span>
<span class="kn">from</span> <span class="nn">jina.jaml</span> <span class="kn">import</span> <span class="n">JAMLCompatible</span>
<span class="kn">from</span> <span class="nn">jina.logging.logger</span> <span class="kn">import</span> <span class="n">JinaLogger</span>
<span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.install_requirements_helper</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_get_package_path_from_uses</span><span class="p">,</span>
    <span class="n">install_package_dependencies</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jina.orchestrate.orchestrator</span> <span class="kn">import</span> <span class="n">BaseOrchestrator</span>
<span class="kn">from</span> <span class="nn">jina.orchestrate.pods.factory</span> <span class="kn">import</span> <span class="n">PodFactory</span>
<span class="kn">from</span> <span class="nn">jina.parsers</span> <span class="kn">import</span> <span class="n">set_deployment_parser</span><span class="p">,</span> <span class="n">set_gateway_parser</span>
<span class="kn">from</span> <span class="nn">jina.parsers.helper</span> <span class="kn">import</span> <span class="n">_update_gateway_args</span>
<span class="kn">from</span> <span class="nn">jina.serve.networking.utils</span> <span class="kn">import</span> <span class="n">host_is_local</span><span class="p">,</span> <span class="n">in_docker</span>

<span class="n">WRAPPED_SLICE_BASE</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\[[-\d:]+\]&#39;</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">jina.clients.base</span> <span class="kn">import</span> <span class="n">BaseClient</span>
    <span class="kn">from</span> <span class="nn">jina.serve.executors</span> <span class="kn">import</span> <span class="n">BaseExecutor</span>


<div class="viewcode-block" id="DeploymentType"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.DeploymentType">[docs]</a><span class="k">class</span> <span class="nc">DeploymentType</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ExitStack</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">JAMLCompatible</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of Deployment, metaclass of :class:`Deployment`&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">_call_add_voters</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="n">voters</span><span class="p">,</span> <span class="n">replica_ids</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="c1"># this method needs to be run in multiprocess, importing jraft in main process</span>
    <span class="c1"># makes it impossible to do tests sequentially</span>
    <span class="kn">from</span> <span class="nn">jina.serve.consensus.add_voter.call_add_voter</span> <span class="kn">import</span> <span class="n">call_add_voter</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to add </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> voters to leader </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">success_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">voter_address</span><span class="p">,</span> <span class="n">replica_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">voters</span><span class="p">,</span> <span class="n">replica_ids</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Trying to add replica-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th time&#39;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">call_add_voter</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">),</span> <span class="n">voter_address</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th time succeeded&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th failed. Wait 2 seconds for next try&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="n">success_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Failed to add </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">. This could be because </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1"> is not the leader, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;and maybe the cluster is restoring from a previous cluster state&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Replica-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> successfully added as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding voters to leader finished&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">success_lists</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_async_call_add_voters</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="n">voters</span><span class="p">,</span> <span class="n">replica_ids</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="c1"># this method needs to be run in multiprocess, importing jraft in main process</span>
    <span class="c1"># makes it impossible to do tests sequentially</span>
    <span class="kn">from</span> <span class="nn">jina.serve.consensus.add_voter.call_add_voter</span> <span class="kn">import</span> <span class="n">async_call_add_voter</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to add </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">replica_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> voters to leader </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">success_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">voter_address</span><span class="p">,</span> <span class="n">replica_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">voters</span><span class="p">,</span> <span class="n">replica_ids</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Trying to add replica-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th time&#39;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_call_add_voter</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">),</span> <span class="n">voter_address</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th time succeeded&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">th failed. Wait 2 seconds for next try&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">success_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Failed to add </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">. This could be because </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1"> is not the leader, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;and maybe the cluster is restoring from a previous cluster state&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Replica-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">replica_id</span><span class="p">)</span><span class="si">}</span><span class="s1"> successfully added as voter with address </span><span class="si">{</span><span class="n">voter_address</span><span class="si">}</span><span class="s1"> to leader at </span><span class="si">{</span><span class="n">leader</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding voters to leader finished&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">success_lists</span><span class="p">)</span>


<div class="viewcode-block" id="Deployment"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment">[docs]</a><span class="k">class</span> <span class="nc">Deployment</span><span class="p">(</span><span class="n">JAMLCompatible</span><span class="p">,</span> <span class="n">PostMixin</span><span class="p">,</span> <span class="n">BaseOrchestrator</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">DeploymentType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Deployment is an immutable set of pods, which run in replicas. They share the same input and output socket.</span>
<span class="sd">    Internally, the pods can run with the process/thread backend. They can also be run in their own containers</span>
<span class="sd">    :param args: arguments parsed from the CLI</span>
<span class="sd">    :param needs: deployments names of preceding deployments, the output of these deployments go into the input of this deployment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_ReplicaSet</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">deployment_args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span>
            <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Namespace</span><span class="p">],</span>
            <span class="n">head_pod</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deployment_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shard_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="o">=</span> <span class="n">head_pod</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">logger_kwargs</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_args</span><span class="p">)</span>
            <span class="n">logger_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">JinaLogger</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">logger_kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_add_voter_to_leader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">leader_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">runtime_ctrl_address</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">voter_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">pod</span><span class="o">.</span><span class="n">runtime_ctrl_address</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">replica_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pod</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replica_id</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting process to call Add Voters&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_call_add_voters</span><span class="p">(</span>
                <span class="n">leader</span><span class="o">=</span><span class="n">leader_address</span><span class="p">,</span>
                <span class="n">voters</span><span class="o">=</span><span class="n">voter_addresses</span><span class="p">,</span>
                <span class="n">replica_ids</span><span class="o">=</span><span class="n">replica_ids</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished adding voters&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Adding Voters did not finish successfully&#39;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_add_voter_to_leader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">leader_address</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">runtime_ctrl_address</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">voter_addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">pod</span><span class="o">.</span><span class="n">runtime_ctrl_address</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">replica_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pod</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replica_id</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting process to call Add Voters&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_async_call_add_voters</span><span class="p">(</span>
                <span class="n">leader</span><span class="o">=</span><span class="n">leader_address</span><span class="p">,</span>
                <span class="n">voters</span><span class="o">=</span><span class="n">voter_addresses</span><span class="p">,</span>
                <span class="n">replica_ids</span><span class="o">=</span><span class="n">replica_ids</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished adding voters&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Adding Voters did not finish successfully&#39;</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">clear_pods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">num_pods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">:</span>
                <span class="n">pod</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">wait_start_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for ReplicaSet to start successfully&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">:</span>
                <span class="n">pod</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
            <span class="c1"># should this be done only when the cluster is started ?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_voter_to_leader</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ReplicaSet started successfully&#39;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">async_wait_start_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for ReplicaSet to start successfully&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span><span class="n">pod</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">()</span> <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># should this be done only when the cluster is started ?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_add_voter_to_leader</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ReplicaSet started successfully&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">_args</span><span class="o">.</span><span class="n">noblock_on_start</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pod</span> <span class="o">=</span> <span class="n">PodFactory</span><span class="o">.</span><span class="n">build_pod</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pod</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
            <span class="n">closing_exception</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">pod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pods</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">closing_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">closing_exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="n">exc_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">closing_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">closing_exception</span>

    <span class="c1"># overload_inject_start_deployment</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">allow_concurrent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compression</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">connection_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_auto_volume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">docker_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">entrypoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exit_on_exceptions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">external</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">floating</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">force_update</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grpc_channel_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grpc_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grpc_server_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">],</span>
        <span class="n">install_requirements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">metrics_exporter_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metrics_exporter_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">monitoring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;executor&#39;</span><span class="p">,</span>
        <span class="n">native</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">no_reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">output_array_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">polling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ANY&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">port_monitoring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefer_platform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">protocol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GRPC&#39;</span><span class="p">],</span>
        <span class="n">provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NONE&#39;</span><span class="p">],</span>
        <span class="n">provider_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">py_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quiet</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">quiet_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raft_configuration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">replicas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">runtime_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WorkerRuntime&#39;</span><span class="p">,</span>
        <span class="n">shards</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ssl_certfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl_keyfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stateful</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout_ctrl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
        <span class="n">timeout_ready</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600000</span><span class="p">,</span>
        <span class="n">timeout_send</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">traces_exporter_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traces_exporter_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tracing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">uses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;BaseExecutor&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;BaseExecutor&#39;</span><span class="p">,</span>
        <span class="n">uses_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;BaseExecutor&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_after_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_before</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s1">&#39;BaseExecutor&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_before_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_dynamic_batching</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_metas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uses_with</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uvicorn_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">volumes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">when</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">workspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Deployment to serve or deploy and Executor or Gateway</span>

<span class="sd">        :param allow_concurrent: Allow concurrent requests to be processed by the Executor. This is only recommended if the Executor is thread-safe.</span>
<span class="sd">        :param compression: The compression mechanism used when sending requests from the Head to the WorkerRuntimes. For more details, check https://grpc.github.io/grpc/python/grpc.html#compression.</span>
<span class="sd">        :param connection_list: dictionary JSON with a list of connections to configure</span>
<span class="sd">        :param cors: If set, a CORS middleware is added to FastAPI frontend to allow cross-origin access.</span>
<span class="sd">        :param description: The description of this HTTP server. It will be used in automatics docs such as Swagger UI.</span>
<span class="sd">        :param disable_auto_volume: Do not automatically mount a volume for dockerized Executors.</span>
<span class="sd">        :param docker_kwargs: Dictionary of kwargs arguments that will be passed to Docker SDK when starting the docker &#39;</span>
<span class="sd">          container.</span>

<span class="sd">          More details can be found in the Docker SDK docs:  https://docker-py.readthedocs.io/en/stable/</span>
<span class="sd">        :param entrypoint: The entrypoint command overrides the ENTRYPOINT in Docker image. when not set then the Docker image ENTRYPOINT takes effective.</span>
<span class="sd">        :param env: The map of environment variables that are available inside runtime</span>
<span class="sd">        :param exit_on_exceptions: List of exceptions that will cause the Executor to shut down.</span>
<span class="sd">        :param external: The Deployment will be considered an external Deployment that has been started independently from the Flow.This Deployment will not be context managed by the Flow.</span>
<span class="sd">        :param floating: If set, the current Pod/Deployment can not be further chained, and the next `.add()` will chain after the last Pod/Deployment not this current one.</span>
<span class="sd">        :param force_update: If set, always pull the latest Hub Executor bundle even it exists on local</span>
<span class="sd">        :param gpus: This argument allows dockerized Jina Executors to discover local gpu devices.</span>

<span class="sd">              Note,</span>
<span class="sd">              - To access all gpus, use `--gpus all`.</span>
<span class="sd">              - To access multiple gpus, e.g. make use of 2 gpus, use `--gpus 2`.</span>
<span class="sd">              - To access specified gpus based on device id, use `--gpus device=[YOUR-GPU-DEVICE-ID]`</span>
<span class="sd">              - To access specified gpus based on multiple device id, use `--gpus device=[YOUR-GPU-DEVICE-ID1],device=[YOUR-GPU-DEVICE-ID2]`</span>
<span class="sd">              - To specify more parameters, use `--gpus device=[YOUR-GPU-DEVICE-ID],runtime=nvidia,capabilities=display</span>
<span class="sd">        :param grpc_channel_options: Dictionary of kwargs arguments that will be passed to the grpc channel as options when creating a channel, example : {&#39;grpc.max_send_message_length&#39;: -1}. When max_attempts &gt; 1, the &#39;grpc.service_config&#39; option will not be applicable.</span>
<span class="sd">        :param grpc_metadata: The metadata to be passed to the gRPC request.</span>
<span class="sd">        :param grpc_server_options: Dictionary of kwargs arguments that will be passed to the grpc server as options when starting the server, example : {&#39;grpc.max_send_message_length&#39;: -1}</span>
<span class="sd">        :param host: The host of the Gateway, which the client should connect to, by default it is 0.0.0.0. In the case of an external Executor (`--external` or `external=True`) this can be a list of hosts.  Then, every resulting address will be considered as one replica of the Executor.</span>
<span class="sd">        :param install_requirements: If set, try to install `requirements.txt` from the local Executor if exists in the Executor folder. If using Hub, install `requirements.txt` in the Hub Executor bundle to local.</span>
<span class="sd">        :param log_config: The config name or the absolute path to the YAML config file of the logger used in this object.</span>
<span class="sd">        :param metrics: If set, the sdk implementation of the OpenTelemetry metrics will be available for default monitoring and custom measurements. Otherwise a no-op implementation will be provided.</span>
<span class="sd">        :param metrics_exporter_host: If tracing is enabled, this hostname will be used to configure the metrics exporter agent.</span>
<span class="sd">        :param metrics_exporter_port: If tracing is enabled, this port will be used to configure the metrics exporter agent.</span>
<span class="sd">        :param monitoring: If set, spawn an http server with a prometheus endpoint to expose metrics</span>
<span class="sd">        :param name: The name of this object.</span>

<span class="sd">              This will be used in the following places:</span>
<span class="sd">              - how you refer to this object in Python/YAML/CLI</span>
<span class="sd">              - visualization</span>
<span class="sd">              - log message header</span>
<span class="sd">              - ...</span>

<span class="sd">              When not given, then the default naming strategy will apply.</span>
<span class="sd">        :param native: If set, only native Executors is allowed, and the Executor is always run inside WorkerRuntime.</span>
<span class="sd">        :param no_reduce: Disable the built-in reduction mechanism. Set this if the reduction is to be handled by the Executor itself by operating on a `docs_matrix` or `docs_map`</span>
<span class="sd">        :param output_array_type: The type of array `tensor` and `embedding` will be serialized to.</span>

<span class="sd">          Supports the same types as `docarray.to_protobuf(.., ndarray_type=...)`, which can be found</span>
<span class="sd">          `here &lt;https://docarray.jina.ai/fundamentals/document/serialization/#from-to-protobuf&gt;`.</span>
<span class="sd">          Defaults to retaining whatever type is returned by the Executor.</span>
<span class="sd">        :param polling: The polling strategy of the Deployment and its endpoints (when `shards&gt;1`).</span>
<span class="sd">              Can be defined for all endpoints of a Deployment or by endpoint.</span>
<span class="sd">              Define per Deployment:</span>
<span class="sd">              - ANY: only one (whoever is idle) Pod polls the message</span>
<span class="sd">              - ALL: all Pods poll the message (like a broadcast)</span>
<span class="sd">              Define per Endpoint:</span>
<span class="sd">              JSON dict, {endpoint: PollingType}</span>
<span class="sd">              {&#39;/custom&#39;: &#39;ALL&#39;, &#39;/search&#39;: &#39;ANY&#39;, &#39;*&#39;: &#39;ANY&#39;}</span>
<span class="sd">        :param port: The port for input data to bind to, default is a random port between [49152, 65535]. In the case of an external Executor (`--external` or `external=True`) this can be a list of ports. Then, every resulting address will be considered as one replica of the Executor.</span>
<span class="sd">        :param port_monitoring: The port on which the prometheus server is exposed, default is a random port between [49152, 65535]</span>
<span class="sd">        :param prefer_platform: The preferred target Docker platform. (e.g. &quot;linux/amd64&quot;, &quot;linux/arm64&quot;)</span>
<span class="sd">        :param protocol: Communication protocol of the server exposed by the Executor. This can be a single value or a list of protocols, depending on your chosen Gateway. Choose the convenient protocols from: [&#39;GRPC&#39;, &#39;HTTP&#39;, &#39;WEBSOCKET&#39;].</span>
<span class="sd">        :param provider: If set, Executor is translated to a custom container compatible with the chosen provider. Choose the convenient providers from: [&#39;NONE&#39;, &#39;SAGEMAKER&#39;].</span>
<span class="sd">        :param provider_endpoint: If set, Executor endpoint will be explicitly chosen and used in the custom container operated by the provider.</span>
<span class="sd">        :param py_modules: The customized python modules need to be imported before loading the executor</span>

<span class="sd">          Note that the recommended way is to only import a single module - a simple python file, if your</span>
<span class="sd">          executor can be defined in a single file, or an ``__init__.py`` file if you have multiple files,</span>
<span class="sd">          which should be structured as a python package. For more details, please see the</span>
<span class="sd">          `Executor cookbook &lt;https://docs.jina.ai/concepts/executor/executor-files/&gt;`__</span>
<span class="sd">        :param quiet: If set, then no log will be emitted from this object.</span>
<span class="sd">        :param quiet_error: If set, then exception stack information will not be added to the log</span>
<span class="sd">        :param raft_configuration: Dictionary of kwargs arguments that will be passed to the RAFT node as configuration options when starting the RAFT node.</span>
<span class="sd">        :param reload: If set, the Executor will restart while serving if YAML configuration source or Executor modules are changed. If YAML configuration is changed, the whole deployment is reloaded and new processes will be restarted. If only Python modules of the Executor have changed, they will be reloaded to the interpreter without restarting process.</span>
<span class="sd">        :param replicas: The number of replicas in the deployment</span>
<span class="sd">        :param retries: Number of retries per gRPC call. If &lt;0 it defaults to max(3, num_replicas)</span>
<span class="sd">        :param runtime_cls: The runtime class to run inside the Pod</span>
<span class="sd">        :param shards: The number of shards in the deployment running at the same time. For more details check https://docs.jina.ai/concepts/flow/create-flow/#complex-flow-topologies</span>
<span class="sd">        :param ssl_certfile: the path to the certificate file</span>
<span class="sd">        :param ssl_keyfile: the path to the key file</span>
<span class="sd">        :param stateful: If set, start consensus module to make sure write operations are properly replicated between all the replicas</span>
<span class="sd">        :param timeout_ctrl: The timeout in milliseconds of the control request, -1 for waiting forever</span>
<span class="sd">        :param timeout_ready: The timeout in milliseconds of a Pod waits for the runtime to be ready, -1 for waiting forever</span>
<span class="sd">        :param timeout_send: The timeout in milliseconds used when sending data requests to Executors, -1 means no timeout, disabled by default</span>
<span class="sd">        :param title: The title of this HTTP server. It will be used in automatics docs such as Swagger UI.</span>
<span class="sd">        :param tls: If set, connect to deployment using tls encryption</span>
<span class="sd">        :param traces_exporter_host: If tracing is enabled, this hostname will be used to configure the trace exporter agent.</span>
<span class="sd">        :param traces_exporter_port: If tracing is enabled, this port will be used to configure the trace exporter agent.</span>
<span class="sd">        :param tracing: If set, the sdk implementation of the OpenTelemetry tracer will be available and will be enabled for automatic tracing of requests and customer span creation. Otherwise a no-op implementation will be provided.</span>
<span class="sd">        :param uses: The config of the executor, it could be one of the followings:</span>
<span class="sd">                  * the string literal of an Executor class name</span>
<span class="sd">                  * an Executor YAML file (.yml, .yaml, .jaml)</span>
<span class="sd">                  * a Jina Hub Executor (must start with `jinahub://` or `jinahub+docker://`)</span>
<span class="sd">                  * a docker image (must start with `docker://`)</span>
<span class="sd">                  * the string literal of a YAML config (must start with `!` or `jtype: `)</span>
<span class="sd">                  * the string literal of a JSON config</span>

<span class="sd">                  When use it under Python, one can use the following values additionally:</span>
<span class="sd">                  - a Python dict that represents the config</span>
<span class="sd">                  - a text file stream has `.read()` interface</span>
<span class="sd">        :param uses_after: The executor attached after the Pods described by --uses, typically used for receiving from all shards, accepted type follows `--uses`. This argument only applies for sharded Deployments (shards &gt; 1).</span>
<span class="sd">        :param uses_after_address: The address of the uses-before runtime</span>
<span class="sd">        :param uses_before: The executor attached before the Pods described by --uses, typically before sending to all shards, accepted type follows `--uses`. This argument only applies for sharded Deployments (shards &gt; 1).</span>
<span class="sd">        :param uses_before_address: The address of the uses-before runtime</span>
<span class="sd">        :param uses_dynamic_batching: Dictionary of keyword arguments that will override the `dynamic_batching` configuration in `uses`</span>
<span class="sd">        :param uses_metas: Dictionary of keyword arguments that will override the `metas` configuration in `uses`</span>
<span class="sd">        :param uses_requests: Dictionary of keyword arguments that will override the `requests` configuration in `uses`</span>
<span class="sd">        :param uses_with: Dictionary of keyword arguments that will override the `with` configuration in `uses`</span>
<span class="sd">        :param uvicorn_kwargs: Dictionary of kwargs arguments that will be passed to Uvicorn server when starting the server</span>

<span class="sd">          More details can be found in Uvicorn docs: https://www.uvicorn.org/settings/</span>
<span class="sd">        :param volumes: The path on the host to be mounted inside the container.</span>

<span class="sd">          Note,</span>
<span class="sd">          - If separated by `:`, then the first part will be considered as the local host path and the second part is the path in the container system.</span>
<span class="sd">          - If no split provided, then the basename of that directory will be mounted into container&#39;s root path, e.g. `--volumes=&quot;/user/test/my-workspace&quot;` will be mounted into `/my-workspace` inside the container.</span>
<span class="sd">          - All volumes are mounted with read-write mode.</span>
<span class="sd">        :param when: The condition that the documents need to fulfill before reaching the Executor.The condition can be defined in the form of a `DocArray query condition &lt;https://docarray.jina.ai/fundamentals/documentarray/find/#query-by-conditions&gt;`</span>
<span class="sd">        :param workspace: The working directory for any IO operations in this object. If not set, then derive from its parent `workspace`.</span>

<span class="sd">        .. # noqa: DAR202</span>
<span class="sd">        .. # noqa: DAR101</span>
<span class="sd">        .. # noqa: DAR003</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># overload_inject_end_deployment</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Namespace&#39;</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">needs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_gateway</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span> <span class="o">=</span> <span class="n">include_gateway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="c1"># arguments exclusive to the gateway</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;ports&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="c1"># arguments common to both gateway and the Executor</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;log_config&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">set_deployment_parser</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">ArgNamespace</span><span class="o">.</span><span class="n">kwargs2namespace</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_load_balancer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">ProviderType</span><span class="o">.</span><span class="n">SAGEMAKER</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8080</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Port 8080 is reserved for Sagemaker deployment. &#39;</span>
                    <span class="s1">&#39;Please use another port&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">8080</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Port is changed to 8080 for Sagemaker deployment. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1"> is ignored&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8080</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="p">[</span><span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Protocol is changed to HTTP for Sagemaker deployment. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Protocol </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1"> is ignored&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="p">[</span><span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span> <span class="ow">and</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_load_balancer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log_config&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">log_config</span> <span class="o">=</span> <span class="n">log_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">polling</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">polling</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;polling&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">PollingType</span><span class="o">.</span><span class="n">ANY</span>
        <span class="p">)</span>
        <span class="c1"># polling only works for shards, if there are none, polling will be ignored</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;shards&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">polling</span> <span class="o">=</span> <span class="n">PollingType</span><span class="o">.</span><span class="n">ANY</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;shards&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span> <span class="o">!=</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;It is not supported to have </span><span class="si">{</span><span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1"> deployment for &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Deployments with more than one shard&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">ProtocolType</span><span class="o">.</span><span class="n">WEBSOCKET</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span> <span class="o">!=</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;It is not supported to have </span><span class="si">{</span><span class="n">ProtocolType</span><span class="o">.</span><span class="n">WEBSOCKET</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1"> deployment for &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Deployments&#39;</span>
            <span class="p">)</span>
        <span class="n">is_mac_os</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span>
        <span class="n">is_windows_os</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span>
        <span class="n">is_37</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">7</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_windows_os</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_mac_os</span> <span class="ow">and</span> <span class="n">is_37</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">is_windows_os</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Stateful feature is not available on Windows&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_mac_os</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Stateful feature when running on MacOS requires Python3.8 or newer version&#39;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">ProtocolType</span><span class="o">.</span><span class="n">WEBSOCKET</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
            <span class="ow">or</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Stateful feature is only available for Deployments using a single </span><span class="si">{</span><span class="n">ProtocolType</span><span class="o">.</span><span class="n">GRPC</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1"> protocol. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1"> were requested&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">needs</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1">#: used in the :class:`jina.flow.Flow` to build the graph</span>

        <span class="c1"># parse addresses for distributed replicas</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_schemes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_tls</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">pod_role</span> <span class="o">!=</span> <span class="n">PodRoleType</span><span class="o">.</span><span class="n">GATEWAY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_external_replica_hosts_and_ports</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_addresses_into_host_and_port</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Number of hosts (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">)</span><span class="si">}</span><span class="s1">) does not match the number of replicas (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_port_monitoring_args</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_pod_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="n">gateway_parser</span> <span class="o">=</span> <span class="n">set_gateway_parser</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">ArgNamespace</span><span class="o">.</span><span class="n">kwargs2namespace</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span><span class="p">,</span> <span class="n">gateway_parser</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>

            <span class="n">args</span><span class="o">.</span><span class="n">deployments_addresses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;executor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection_list_for_single_executor</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">graph_description</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;{&quot;start-gateway&quot;: [&quot;executor&quot;], &quot;executor&quot;: [&quot;end-gateway&quot;]}&#39;</span>
            <span class="p">)</span>
            <span class="n">_update_gateway_args</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">gateway_load_balancer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_load_balancer</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">JinaLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_connection_list_for_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="p">:</span>
            <span class="c1"># add head information</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">head_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># there is no head, add the worker connection information instead</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ports</span>
            <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">__docker_host__</span>
                    <span class="k">if</span> <span class="n">host_is_local</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="ow">and</span> <span class="n">in_docker</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span>
                    <span class="k">else</span> <span class="n">host</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hosts</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hosts</span><span class="p">,</span> <span class="n">ports</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_connection_list_for_single_executor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="p">:</span>
            <span class="c1"># add head information</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">head_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># there is no head, add the worker connection information instead</span>
            <span class="n">ports_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">replica_pod_arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">replica_pod_arg</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">replica_pod_arg</span><span class="o">.</span><span class="n">port</span>
                <span class="p">):</span>
                    <span class="n">ports_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">protocol</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

            <span class="n">host</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">__docker_host__</span>
                <span class="k">if</span> <span class="n">host_is_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">in_docker</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">connection_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">ports</span> <span class="ow">in</span> <span class="n">ports_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">connection_dict</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protocol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span>
                <span class="p">]</span>
            <span class="k">return</span> <span class="n">connection_dict</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">send_telemetry_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                <span class="n">obj_cls_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">entity_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_id</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">,</span>
                <span class="n">exc_type</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc_type</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_addresses_into_host_and_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># splits addresses passed to `host` into separate `host` and `port`</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">):</span>
            <span class="n">_hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">tls</span> <span class="o">=</span> <span class="n">parse_host_scheme</span><span class="p">(</span><span class="n">_host</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_hostname</span> <span class="o">!=</span> <span class="n">_host</span><span class="p">:</span>  <span class="c1"># more than just hostname was passed to `host`</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hostname</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span class="n">tls</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">repl_host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">):</span>
            <span class="n">_hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">tls</span> <span class="o">=</span> <span class="n">parse_host_scheme</span><span class="p">(</span><span class="n">repl_host</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">_hostname</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">):</span>  <span class="c1"># more than just hostname was passed to `host`</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hostname</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_schemes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scheme</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_tls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tls</span>

    <span class="k">def</span> <span class="nf">_parse_external_replica_hosts_and_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># splits user provided lists of hosts and ports into a host and port for every distributed replica</span>
        <span class="n">ext_repl_ports</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ext_repl_hosts</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">):</span>  <span class="c1"># only one host given, assume replicas are on the same host</span>
                <span class="n">ext_repl_hosts</span> <span class="o">=</span> <span class="n">ext_repl_hosts</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">):</span>  <span class="c1"># only one port given, assume replicas are on the same port</span>
                <span class="n">ext_repl_ports</span> <span class="o">=</span> <span class="n">ext_repl_ports</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Number of hosts (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_hosts</span><span class="p">)</span><span class="si">}</span><span class="s1">) does not match the number of ports (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_repl_ports</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span> <span class="o">=</span> <span class="n">ext_repl_hosts</span><span class="p">,</span> <span class="n">ext_repl_ports</span>
        <span class="c1"># varying tls and schemes other than &#39;grpc&#39; only implemented if the entire address is passed to `host`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_schemes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;scheme&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_tls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;tls&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_port_monitoring_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_all_port_monitoring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port_monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">_all_port_monitoring</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">_all_port_monitoring</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span>
            <span class="k">else</span> <span class="n">_all_port_monitoring</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># this is for the head</span>

<div class="viewcode-block" id="Deployment.update_pod_args"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.update_pod_args">[docs]</a>    <span class="k">def</span> <span class="nf">update_pod_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update args of all its pods based on Deployment args. Including head/tail&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">runtime_cls</span> <span class="o">==</span> <span class="s1">&#39;GatewayRuntime&#39;</span><span class="p">:</span>
            <span class="n">_update_gateway_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
            <span class="c1"># This is used when a Deployment is created in a remote context, where pods &amp; their connections are already given.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Deployment.update_worker_pod_args"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.update_worker_pod_args">[docs]</a>    <span class="k">def</span> <span class="nf">update_worker_pod_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update args of all its worker pods based on Deployment args. Does not touch head and tail&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_pod_args</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">role</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DeploymentRoleType&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the role of this :class:`Deployment`.</span>

<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The name of this :class:`Deployment`.</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">head_host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the host of the HeadPod of this deployment</span>
<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">host</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">head_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the port of the HeadPod of this deployment</span>
<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">head_port_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the port_monitoring of the HeadPod of this deployment</span>
<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BaseClient&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a :class:`BaseClient` object attach to this Flow.</span>

<span class="sd">        .. # noqa: DAR201&quot;&quot;&quot;</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">grpc_channel_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">grpc_channel_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Client</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_copy_to_head_args</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the outgoing args of the head router</span>

<span class="sd">        :param args: basic arguments</span>
<span class="sd">        :return: enriched head arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_head_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">polling</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">polling</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">uses</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">uses</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">pod_role</span> <span class="o">=</span> <span class="n">PodRoleType</span><span class="o">.</span><span class="n">HEAD</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">runtime_cls</span> <span class="o">=</span> <span class="s1">&#39;HeadRuntime&#39;</span>
        <span class="n">_head_args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">_head_args</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/head&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_head_args</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;head&#39;</span>

        <span class="k">return</span> <span class="n">_head_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get deployments of the deployment. The Deployment just gives one deployment.</span>

<span class="sd">        :return: list of deployments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;head_host&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_host</span><span class="p">,</span>
                <span class="s1">&#39;head_port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_port</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_docker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this deployment is to be run in Docker.</span>

<span class="sd">        :return: True if this deployment is to be run in Docker</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">hubble.executor.helper</span> <span class="kn">import</span> <span class="n">is_valid_docker_uri</span>

        <span class="n">uses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">is_valid_docker_uri</span><span class="p">(</span><span class="n">uses</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_executor_from_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this deployment is to be run from YAML configuration.</span>

<span class="sd">        :return: True if this deployment is to be run from YAML configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uses</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;yml&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">uses</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;yaml&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tls_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if secure connection via TLS is enabled for this Deployment.</span>

<span class="sd">        :return: True if tls is enabled, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_cert</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;ssl_certfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">has_key</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;ssl_keyfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">tls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;tls&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tls</span> <span class="ow">or</span> <span class="p">(</span><span class="n">has_cert</span> <span class="ow">and</span> <span class="n">has_key</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this deployment is external.</span>

<span class="sd">        :return: True if this deployment is provided as an external deployment, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grpc_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the gRPC metadata for this deployment</span>
<span class="sd">        :return: The gRPC metadata for this deployment. If the deployment is a Gateway, return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;grpc_metadata&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the protocol of this deployment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="n">protocol</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;grpc&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocol</span><span class="p">]</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls_enabled</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_p</span> <span class="ow">in</span> <span class="n">protocol</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocol</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_pod_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the first worker pod&#39;s args</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note this will be never out of boundary</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the host name of this deployment</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">host</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: The port of this deployment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of ports exposed by this Deployment.</span>
<span class="sd">        Exposed means these are the ports a Client/Gateway is supposed to communicate with.</span>
<span class="sd">        For sharded deployments this will be the head_port.</span>
<span class="sd">        For non-sharded deployments it will be all replica ports.</span>
<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_port</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">head_port</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">ports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ports</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of host addresses exposed by this Deployment.</span>
<span class="sd">        Exposed means these are the host a Client/Gateway is supposed to communicate with.</span>
<span class="sd">        For sharded deployments this will be the head host.</span>
<span class="sd">        For non-sharded deployments it will be all replica hosts.</span>
<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_host</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">head_host</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">replica</span><span class="o">.</span><span class="n">host</span> <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_parse_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Namespace</span><span class="p">],</span> <span class="n">Namespace</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_base_deployment_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">head_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the arguments for the `head` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span>

    <span class="nd">@head_args</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">head_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the arguments for the `head` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR101</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_before_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the arguments for the `uses_before` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span>

    <span class="nd">@uses_before_args</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uses_before_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the arguments for the `uses_before` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR101</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_after_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the arguments for the `uses_after` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span>

    <span class="nd">@uses_after_args</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uses_after_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the arguments for the `uses_after` of this Deployment.</span>


<span class="sd">        .. # noqa: DAR101</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Namespace</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all arguments of all Pods in this Deployment.</span>

<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="o">+</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]:</span>
            <span class="n">all_args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="n">shard_id</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">all_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_pods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of running :class:`Pod`</span>

<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_pods</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_pods</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_pods</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_pods</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_pods</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>  <span class="c1"># external deployments</span>
            <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="n">num_pods</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">num_pods</span>
        <span class="k">return</span> <span class="n">num_pods</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Deployment&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pods</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">num_pods</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Deployment.get_worker_host"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.get_worker_host">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_worker_host</span><span class="p">(</span><span class="n">pod_args</span><span class="p">,</span> <span class="n">pod_is_container</span><span class="p">,</span> <span class="n">head_is_container</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current pod and head are both containerized on the same host</span>
<span class="sd">        If so, __docker_host__ needs to be advertised as the worker&#39;s address to the head</span>

<span class="sd">        :param pod_args: arguments of the worker pod</span>
<span class="sd">        :param pod_is_container: boolean specifying if pod is to be run in container</span>
<span class="sd">        :param head_is_container: boolean specifying if head pod is to be run in container</span>
<span class="sd">        :return: host to pass in connection list of the head</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the current pod and head are both containerized on the same host</span>
        <span class="c1"># If so __docker_host__ needs to be advertised as the worker&#39;s address to the head</span>
        <span class="n">worker_host</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">__docker_host__</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pod_is_container</span> <span class="ow">and</span> <span class="p">(</span><span class="n">head_is_container</span> <span class="ow">or</span> <span class="n">in_docker</span><span class="p">()))</span>
            <span class="ow">and</span> <span class="n">host_is_local</span><span class="p">(</span><span class="n">pod_args</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">pod_args</span><span class="o">.</span><span class="n">host</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">worker_host</span></div>

    <span class="k">def</span> <span class="nf">_wait_until_all_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">warnings</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">wait_for_ready_coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

            <span class="k">async</span> <span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
                <span class="k">pass</span>

            <span class="n">running_in_event_loop</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">_f</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">running_in_event_loop</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">running_in_event_loop</span><span class="p">:</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">wait_for_ready_coro</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wait_ready_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">wait_ready_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">wait_ready_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<div class="viewcode-block" id="Deployment.start"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Deployment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start to run all :class:`Pod` in this Deployment.</span>

<span class="sd">        :return: started deployment</span>

<span class="sd">        .. note::</span>
<span class="sd">            If one of the :class:`Pod` fails to start, make sure that all of them</span>
<span class="sd">            are properly closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;install_requirements&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">install_package_dependencies</span><span class="p">(</span><span class="n">_get_package_path_from_uses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">uses</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">noblock_on_start</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="o">=</span> <span class="n">PodFactory</span><span class="o">.</span><span class="n">build_pod</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">noblock_on_start</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="o">=</span> <span class="n">PodFactory</span><span class="o">.</span><span class="n">build_pod</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span><span class="p">)</span>

        <span class="n">num_shards</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReplicaSet</span><span class="p">(</span>
                <span class="n">deployment_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="n">shard_id</span><span class="p">],</span>
                <span class="n">head_pod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-replica-set-</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">num_shards</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-replica-set&#39;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">noblock_on_start</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="o">=</span> <span class="n">PodFactory</span><span class="o">.</span><span class="n">build_pod</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">noblock_on_start</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="o">=</span> <span class="n">PodFactory</span><span class="o">.</span><span class="n">build_pod</span><span class="p">(</span>
                <span class="n">_args</span><span class="p">,</span> <span class="n">gateway_load_balancer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_load_balancer</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">noblock_on_start</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_until_all_ready</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="n">all_panels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary_table</span><span class="p">(</span><span class="n">all_panels</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">rich.rule</span> <span class="kn">import</span> <span class="n">Rule</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="s1">&#39;:tada: Deployment is ready to serve!&#39;</span><span class="p">),</span> <span class="o">*</span><span class="n">all_panels</span><span class="p">)</span>

            <span class="n">send_telemetry_event</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span>
                <span class="n">obj_cls_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">entity_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Deployment.wait_start_success"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.wait_start_success">[docs]</a>    <span class="k">def</span> <span class="nf">wait_start_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until all pods start successfully.</span>

<span class="sd">        If not successful, it will raise an error hoping the outer function will catch it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">wait_start_success</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Deployment.async_wait_start_success"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.async_wait_start_success">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">async_wait_start_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until all pods start successfully.</span>

<span class="sd">        If unsuccessful, it will raise an error hoping the outer function will catch it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coros</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="n">coros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">async_wait_start_success</span><span class="p">())</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">coros</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deployment started successfully&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Deployment.join"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait until all pods exit&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">clear_pods</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if Deployment is ready</span>

<span class="sd">        .. note::</span>
<span class="sd">            A Deployment is ready when all the Pods it contains are ready</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_ready</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_pod</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_ready</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_ready</span>
        <span class="k">if</span> <span class="n">is_ready</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_pod</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_ready</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_pod</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_ready</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_pod</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">is_ready</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_devices</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_devices</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a list of devices from string, like `start:stop:step` or &#39;num1,num2,num3` or combination of both.</span>

<span class="sd">        :param value: a string-like</span>
<span class="sd">        :param num_devices: total number of devices</span>
<span class="sd">        :return: slice</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">use_uuids</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">WRAPPED_SLICE_BASE</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">use_uuids</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">use_uuids</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">parts</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># try to detect if parts are not numbers</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">use_uuids</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">use_uuids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">parts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_devices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_devices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_devices</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">])]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_roundrobin_cuda_device</span><span class="p">(</span><span class="n">device_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">replicas</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse CUDA device string with RR prefix</span>

<span class="sd">        :param device_str: `RRm:n`, where `RR` is the prefix, m:n is python slice format</span>
<span class="sd">        :param replicas: the number of replicas</span>
<span class="sd">        :return: a map from replica ID to device ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">device_str</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">device_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;RR&#39;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">replicas</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">num_devices</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">,</span> <span class="s1">&#39;-L&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">count</span><span class="p">(</span>
                    <span class="s1">&#39;UUID&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">num_devices</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CUDA_TOTAL_DEVICES&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">num_devices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="n">selected_devices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">device_str</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">Deployment</span><span class="o">.</span><span class="n">_parse_devices</span><span class="p">(</span><span class="n">device_str</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">num_devices</span><span class="p">):</span>
                    <span class="n">selected_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_devices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_devices</span><span class="p">)</span>
            <span class="n">_c</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">selected_devices</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="n">_c</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">replicas</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_set_pod_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Namespace</span><span class="p">]]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">shards</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;shards&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">replicas</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;replicas&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span> <span class="o">==</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span><span class="p">:</span>
            <span class="n">replicas</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sharding_enabled</span> <span class="o">=</span> <span class="n">shards</span> <span class="ow">and</span> <span class="n">shards</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="n">cuda_device_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;RR&#39;</span><span class="p">):</span>
            <span class="n">args_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">cuda_visible_devices</span> <span class="o">=</span> <span class="n">args_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">cuda_device_map</span> <span class="o">=</span> <span class="n">Deployment</span><span class="o">.</span><span class="n">_roundrobin_cuda_device</span><span class="p">(</span>
                <span class="n">cuda_visible_devices</span><span class="p">,</span> <span class="n">replicas</span>
            <span class="p">)</span>

        <span class="n">all_shard_pod_ports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">peer_ports</span> <span class="ow">or</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_shard_pod_ports</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">all_shard_pod_ports</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">all_shard_pod_ports</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_shard_pod_ports</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># it is a single shard</span>
            <span class="n">all_shard_pod_ports</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="n">all_shard_pod_ports</span><span class="p">}</span>

        <span class="n">peer_ports_all_shards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_shard_pod_ports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">peer_ports_all_shards</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_ports_all_shards</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">shards</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The configuration of `peer_ports` does not match the number of shards requested&#39;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shards</span><span class="p">):</span>
            <span class="n">peer_ports</span> <span class="o">=</span> <span class="n">peer_ports_all_shards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">shard_id</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_ports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_ports</span><span class="p">)</span> <span class="o">!=</span> <span class="n">replicas</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;peer-ports argument does not match number of replicas, it will be ignored&#39;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">peer_ports</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">peer_ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_port</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">replicas</span><span class="p">)]</span>

            <span class="n">replica_args</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">replica_id</span><span class="p">,</span> <span class="n">peer_port</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">replicas</span><span class="p">),</span> <span class="n">peer_ports</span><span class="p">):</span>
                <span class="n">_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span> <span class="o">==</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
                <span class="n">_args</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">=</span> <span class="n">shard_id</span>
                <span class="n">_args</span><span class="o">.</span><span class="n">replica_id</span> <span class="o">=</span> <span class="n">replica_id</span>
                <span class="c1"># for gateway pods, the pod role shouldn&#39;t be changed</span>
                <span class="k">if</span> <span class="n">_args</span><span class="o">.</span><span class="n">pod_role</span> <span class="o">!=</span> <span class="n">PodRoleType</span><span class="o">.</span><span class="n">GATEWAY</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">pod_role</span> <span class="o">=</span> <span class="n">PodRoleType</span><span class="o">.</span><span class="n">WORKER</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="o">==</span> <span class="n">replicas</span><span class="p">:</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">host</span>

                <span class="k">if</span> <span class="n">cuda_device_map</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">_args</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cuda_device_map</span><span class="p">[</span><span class="n">replica_id</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">_args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;/shard-</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s1">/rep-</span><span class="si">{</span><span class="n">replica_id</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">sharding_enabled</span>
                        <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;/rep-</span><span class="si">{</span><span class="n">replica_id</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">replica_id</span><span class="si">}</span><span class="s1">&#39;</span>

                <span class="c1"># the gateway needs to respect the assigned port</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployment_role</span> <span class="o">==</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span>

                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">shards</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">replicas</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_args</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
                            <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">random_port</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>
                            <span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port_monitoring</span>

                    <span class="k">elif</span> <span class="n">shards</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">random_port</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">replica_id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span><span class="p">)</span>
                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="c1"># if there are no shards/replicas, we dont need to distribute ports randomly</span>
                        <span class="c1"># we should rather use the pre assigned one</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">random_port</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>
                        <span class="p">]</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_port</span>
                    <span class="k">elif</span> <span class="n">shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">port_monitoring_index</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">replica_id</span> <span class="o">+</span> <span class="n">replicas</span> <span class="o">*</span> <span class="n">shard_id</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="p">)</span>  <span class="c1"># the first index is for the head</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">random_port</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">port_monitoring_index</span>
                            <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span><span class="p">)</span>
                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">all_port_monitoring</span><span class="p">[</span>
                                <span class="n">port_monitoring_index</span>
                            <span class="p">]</span>  <span class="c1"># we skip the head port here</span>
                        <span class="p">)</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="n">peer_port</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="n">peer_port</span><span class="p">]</span>
                        <span class="n">_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="n">random_port</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_ports</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]]</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_hosts</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_schemes</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_repl_tls</span><span class="p">[</span><span class="n">replica_id</span><span class="p">]</span>

                <span class="c1"># pod workspace if not set then derive from workspace</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_args</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span>
                    <span class="n">_args</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">workspace</span>
                <span class="n">replica_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_args</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica_args</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_uses_before_after_args</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Namespace</span><span class="p">:</span>
        <span class="n">_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">_args</span><span class="o">.</span><span class="n">pod_role</span> <span class="o">=</span> <span class="n">PodRoleType</span><span class="o">.</span><span class="n">WORKER</span>
        <span class="n">_args</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">_args</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">__default_host__</span>
        <span class="n">_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_port</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">_args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s1">-0&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s1">-0&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;uses_before&#39;</span> <span class="o">==</span> <span class="n">entity_type</span><span class="p">:</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">uses_requests</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">uses</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">uses_before</span> <span class="ow">or</span> <span class="n">__default_executor__</span>
        <span class="k">elif</span> <span class="s1">&#39;uses_after&#39;</span> <span class="o">==</span> <span class="n">entity_type</span><span class="p">:</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">uses_requests</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">uses</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">uses_after</span> <span class="ow">or</span> <span class="n">__default_executor__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;uses_before/uses_after pod does not support type </span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># pod workspace if not set then derive from workspace</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_args</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span>
            <span class="n">_args</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">workspace</span>
        <span class="k">return</span> <span class="n">_args</span>

    <span class="k">def</span> <span class="nf">_parse_base_deployment_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">parsed_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;head&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;uses_before&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;uses_after&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;gateway&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;pods&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Stateful Executor is not recommended to be used less than 3 replicas&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">stateful</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Stateful Executors need to be provided `workspace` when used in a Deployment&#39;</span>
            <span class="p">)</span>

        <span class="c1"># a gateway has no heads and uses</span>
        <span class="c1"># also there a no heads created, if there are no shards</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;shards&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;uses_before&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">uses_before</span> <span class="o">!=</span> <span class="n">__default_executor__</span>
            <span class="p">):</span>
                <span class="n">uses_before_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_uses_before_after_args</span><span class="p">(</span>
                    <span class="n">args</span><span class="p">,</span> <span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;uses_before&#39;</span>
                <span class="p">)</span>
                <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;uses_before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uses_before_args</span>
                <span class="n">args</span><span class="o">.</span><span class="n">uses_before_address</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uses_before_args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">uses_before_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;uses_after&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">uses_after</span> <span class="o">!=</span> <span class="n">__default_executor__</span>
            <span class="p">):</span>
                <span class="n">uses_after_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_uses_before_after_args</span><span class="p">(</span>
                    <span class="n">args</span><span class="p">,</span> <span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;uses_after&#39;</span>
                <span class="p">)</span>
                <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;uses_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uses_after_args</span>
                <span class="n">args</span><span class="o">.</span><span class="n">uses_after_address</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uses_after_args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">uses_after_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Deployment</span><span class="o">.</span><span class="n">_copy_to_head_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_pod_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connection_list</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">pod_idx</span><span class="p">,</span> <span class="n">pod_args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="n">shard_id</span><span class="p">]):</span>
                    <span class="n">worker_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_worker_host</span><span class="p">(</span><span class="n">pod_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">connection_list</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">worker_host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">pod_args</span><span class="o">.</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
            <span class="n">parsed_args</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">connection_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">connection_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mermaid_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String that will be used to represent the Deployment graphically when `Flow.plot()` is invoked.</span>
<span class="sd">        It does not include used_before/uses_after</span>


<span class="sd">        .. # noqa: DAR201</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mermaid_graph</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="s1">&#39;&amp;ltsecret&amp;gt&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">DeploymentRoleType</span><span class="o">.</span><span class="n">GATEWAY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="n">mermaid_graph</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;subgraph </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">direction LR;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>

            <span class="n">uses_before_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_args</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">uses_before_uses</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">replace_secret_of_hub_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_before_args</span><span class="o">.</span><span class="n">uses</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_before_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">uses_after_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_args</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">uses_after_uses</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">replace_secret_of_hub_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_after_args</span><span class="o">.</span><span class="n">uses</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_after_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">shard_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># multiple shards</span>
                <span class="k">for</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">pod_args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">shard_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/shard-</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">shard_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shard_name</span><span class="p">)</span>
                    <span class="n">shard_mermaid_graph</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="sa">f</span><span class="s1">&#39;subgraph </span><span class="si">{</span><span class="n">shard_name</span><span class="si">}</span><span class="s1">;&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">direction TB;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">pod_args</span>
                    <span class="p">]</span>  <span class="c1"># all the names of each of the replicas</span>
                    <span class="n">uses</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">uses</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">pod_args</span>
                    <span class="p">]</span>  <span class="c1"># all the uses should be the same but let&#39;s keep it this</span>
                    <span class="c1"># way</span>
                    <span class="k">for</span> <span class="n">rep_i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">uses</span><span class="p">)):</span>
                        <span class="n">escaped_uses</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">replace_secret_of_hub_uri</span><span class="p">(</span><span class="n">use</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="n">shard_mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="n">escaped_uses</span><span class="si">}</span><span class="s1">]:::pod;&#39;</span><span class="p">)</span>
                    <span class="n">shard_mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;end;&#39;</span><span class="p">)</span>
                    <span class="n">shard_mermaid_graph</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">shard_mermaid_graph</span>
                    <span class="p">]</span>
                    <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shard_mermaid_graph</span><span class="p">)</span>
                    <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uses_before_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">shard_name</span> <span class="ow">in</span> <span class="n">shard_names</span><span class="p">:</span>
                        <span class="n">escaped_uses_before_uses</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">replace_secret_of_hub_uri</span><span class="p">(</span><span class="n">uses_before_uses</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="p">)</span>
                        <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-head[</span><span class="si">{</span><span class="n">escaped_uses_before_uses</span><span class="si">}</span><span class="s1">]:::HEADTAIL --&gt; </span><span class="si">{</span><span class="n">shard_name</span><span class="si">}</span><span class="s1">;&#39;</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">uses_after_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">shard_name</span> <span class="ow">in</span> <span class="n">shard_names</span><span class="p">:</span>
                        <span class="n">escaped_uses_after_uses</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">uses_after_uses</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">shard_name</span><span class="si">}</span><span class="s1"> --&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-tail[</span><span class="si">{</span><span class="n">escaped_uses_after_uses</span><span class="si">}</span><span class="s1">]:::HEADTAIL;&#39;</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># single shard case, no uses_before or uses_after_considered</span>
                <span class="n">pod_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uses</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">replace_secret_of_hub_uri</span><span class="p">(</span><span class="n">pod_args</span><span class="o">.</span><span class="n">uses</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

                <span class="c1"># just put the replicas in parallel</span>
                <span class="k">if</span> <span class="n">pod_args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">rep_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pod_args</span><span class="o">.</span><span class="n">replicas</span><span class="p">):</span>
                        <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pod_args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/rep-</span><span class="si">{</span><span class="n">rep_i</span><span class="si">}</span><span class="s1">[&quot;</span><span class="si">{</span><span class="n">uses</span><span class="si">}</span><span class="s1">&quot;]:::pod;&#39;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pod_args</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">[&quot;</span><span class="si">{</span><span class="n">uses</span><span class="si">}</span><span class="s1">&quot;]:::pod;&#39;</span><span class="p">)</span>

            <span class="n">mermaid_graph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;end;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mermaid_graph</span>

<div class="viewcode-block" id="Deployment.block"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.block">[docs]</a>    <span class="k">def</span> <span class="nf">block</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stop_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;threading.Event&#39;</span><span class="p">,</span> <span class="s1">&#39;multiprocessing.Event&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block the Deployment until `stop_event` is set or user hits KeyboardInterrupt</span>

<span class="sd">        :param stop_event: a threading event or a multiprocessing event that once set will resume the control flow</span>
<span class="sd">            to main thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_reload_deployment</span><span class="p">(</span><span class="n">changed_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;change in Executor configuration YAML </span><span class="si">{</span><span class="n">changed_file</span><span class="si">}</span><span class="s1"> observed, reloading Executor deployment&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_deployment</span> <span class="o">=</span> <span class="n">Deployment</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs</span><span class="p">,</span> <span class="n">include_gateway</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">new_deployment</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">watch_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">reload</span>

            <span class="k">if</span> <span class="n">watch_changes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_executor_from_yaml</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ImportExtensions</span><span class="p">(</span>
                    <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;reload requires watchfiles dependency to be installed. You can run `pip install </span>
<span class="s1">                    watchfiles&#39;&#39;&#39;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="kn">from</span> <span class="nn">watchfiles</span> <span class="kn">import</span> <span class="n">watch</span>

                <span class="n">new_stop_event</span> <span class="o">=</span> <span class="n">stop_event</span> <span class="ow">or</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_executor_from_yaml</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">watch</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">uses</span><span class="p">],</span> <span class="n">stop_event</span><span class="o">=</span><span class="n">new_stop_event</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">changed_file</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                            <span class="n">_reload_deployment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">uses</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wait_event</span> <span class="o">=</span> <span class="n">stop_event</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">wait_event</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
                    <span class="n">wait_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">__windows__</span><span class="p">:</span>
                    <span class="n">wait_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">wait_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                            <span class="k">break</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_get_summary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_panels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Panel</span><span class="p">]):</span>
        <span class="n">address_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)</span> <span class="k">for</span> <span class="n">_p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_ports</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_ports</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)</span> <span class="k">for</span> <span class="n">_p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port</span><span class="p">]</span>

        <span class="n">swagger_ui_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">redoc_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_port</span><span class="p">,</span> <span class="n">_protocol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_ports</span><span class="p">,</span> <span class="n">_protocols</span><span class="p">):</span>
            <span class="n">address_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s1">&#39;:chains:&#39;</span><span class="p">,</span> <span class="s1">&#39;Protocol&#39;</span><span class="p">,</span> <span class="n">_protocol</span><span class="p">)</span>

            <span class="n">_protocol</span> <span class="o">=</span> <span class="n">_protocol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">address_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="s1">&#39;:house:&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Local&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;[link=</span><span class="si">{</span><span class="n">_protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">[/]&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">address_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="s1">&#39;:lock:&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Private&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;[link=</span><span class="si">{</span><span class="n">_protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">address_private</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">address_private</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">[/]&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_public</span><span class="p">:</span>
                <span class="n">address_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                    <span class="s1">&#39;:earth_africa:&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Public&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;[link=</span><span class="si">{</span><span class="n">_protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">address_public</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">address_public</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">[/]&#39;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">swagger_ui_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[link=</span><span class="si">{</span><span class="n">_protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">/docs]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">/docs&#39;</span>
                <span class="n">redoc_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[link=</span><span class="si">{</span><span class="n">_protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">/redoc]</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_port</span><span class="si">}</span><span class="s1">/redoc&#39;</span>

        <span class="n">all_panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Panel</span><span class="p">(</span>
                <span class="n">address_table</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;:link: [b]Endpoint[/]&#39;</span><span class="p">,</span>
                <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">HTTP</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_protocols</span><span class="p">]:</span>
            <span class="n">http_ext_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">()</span>
            <span class="n">http_ext_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s1">&#39;:speech_balloon:&#39;</span><span class="p">,</span> <span class="s1">&#39;Swagger UI&#39;</span><span class="p">,</span> <span class="n">swagger_ui_link</span><span class="p">)</span>

            <span class="n">http_ext_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s1">&#39;:books:&#39;</span><span class="p">,</span> <span class="s1">&#39;Redoc&#39;</span><span class="p">,</span> <span class="n">redoc_link</span><span class="p">)</span>

            <span class="n">all_panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Panel</span><span class="p">(</span>
                    <span class="n">http_ext_table</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;:gem: [b]HTTP extension[/]&#39;</span><span class="p">,</span>
                    <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">monitoring</span><span class="p">:</span>
            <span class="n">monitor_ext_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;pods&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">monitor_ext_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                    <span class="s1">&#39;:flashlight:&#39;</span><span class="p">,</span>  <span class="c1"># upstream issue: they dont have :torch: emoji, so we use :flashlight:</span>
                    <span class="c1"># to represent observability of Prometheus (even they have :torch: it will be a war</span>
                    <span class="c1"># between AI community and Cloud-native community fighting on this emoji)</span>
                    <span class="n">replica</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;...[b]:</span><span class="si">{</span><span class="n">replica</span><span class="o">.</span><span class="n">port_monitoring</span><span class="si">}</span><span class="s1">[/]&#39;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">all_panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Panel</span><span class="p">(</span>
                        <span class="n">monitor_ext_table</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;:gem: [b]Prometheus extension[/]&#39;</span><span class="p">,</span>
                        <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">all_panels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_docker_compose_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.config.docker_compose</span> <span class="kn">import</span> <span class="n">port</span>
        <span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.config.helper</span> <span class="kn">import</span> <span class="n">to_compatible_name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="n">docker_compose_address</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="p">:</span>
            <span class="n">docker_compose_address</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_compatible_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;gateway&#39;</span><span class="p">:</span>
                <span class="n">docker_compose_address</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_compatible_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">docker_compose_address</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">rep_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">replicas</span><span class="p">):</span>
                    <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/rep-</span><span class="si">{</span><span class="n">rep_id</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">docker_compose_address</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_compatible_name</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">docker_compose_address</span>

    <span class="k">def</span> <span class="nf">_to_docker_compose_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployments_addresses</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.config.docker_compose</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">DockerComposeConfig</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">docker_compose_deployment</span> <span class="o">=</span> <span class="n">DockerComposeConfig</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">deployments_addresses</span><span class="o">=</span><span class="n">deployments_addresses</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docker_compose_deployment</span><span class="o">.</span><span class="n">to_docker_compose_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_inner_gateway_to_docker_compose_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.config.docker_compose</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">DockerComposeConfig</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">port</span> <span class="ow">or</span> <span class="p">[</span><span class="n">random_port</span><span class="p">()]</span>
        <span class="n">cargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_args</span><span class="p">[</span><span class="s1">&#39;gateway&#39;</span><span class="p">])</span>
        <span class="n">cargs</span><span class="o">.</span><span class="n">uses</span> <span class="o">=</span> <span class="n">__default_grpc_gateway__</span>
        <span class="n">cargs</span><span class="o">.</span><span class="n">graph_description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;: [&quot;end-gateway&quot;], &quot;start-gateway&quot;: [&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;]</span><span class="se">}}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">docker_compose_deployment</span> <span class="o">=</span> <span class="n">DockerComposeConfig</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="n">cargs</span><span class="p">,</span>
            <span class="n">deployments_addresses</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_compose_address</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docker_compose_deployment</span><span class="o">.</span><span class="n">to_docker_compose_config</span><span class="p">()</span>

<div class="viewcode-block" id="Deployment.to_docker_compose_yaml"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.to_docker_compose_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">to_docker_compose_yaml</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a Jina Deployment into a Docker compose YAML file</span>

<span class="sd">        If you don&#39;t want to rebuild image on Executor Hub,</span>
<span class="sd">        you can set `JINA_HUB_NO_IMAGE_REBUILD` environment variable.</span>

<span class="sd">        :param output_path: The path to dump the YAML file to</span>
<span class="sd">        :param network_name: The name of the network that will be used by the deployment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="ow">or</span> <span class="s1">&#39;docker-compose.yml&#39;</span>
        <span class="n">network_name</span> <span class="o">=</span> <span class="n">network_name</span> <span class="ow">or</span> <span class="s1">&#39;jina-network&#39;</span>

        <span class="n">docker_compose_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;networks&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">network_name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;bridge&#39;</span><span class="p">}},</span>
        <span class="p">}</span>
        <span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">service_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_docker_compose_config</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">service_configs</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;networks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">network_name</span><span class="p">]</span>
            <span class="n">services</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_gateway</span><span class="p">:</span>
            <span class="n">service_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_gateway_to_docker_compose_config</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">service_configs</span><span class="p">:</span>
                <span class="n">service</span><span class="p">[</span><span class="s1">&#39;networks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">network_name</span><span class="p">]</span>
                <span class="n">services</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>

        <span class="n">docker_compose_dict</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">services</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">docker_compose_dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;docker-compose up&#39;</span>
            <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;docker-compose -f </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s1"> up&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Docker Compose file has been created under [b]</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s1">[/b]. You can use it by running [b]</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1">[/b]&#39;</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_to_kubernetes_yaml</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k8s_namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">k8s_deployments_addresses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="kn">from</span> <span class="nn">jina.orchestrate.deployments.config.k8s</span> <span class="kn">import</span> <span class="n">K8sDeploymentConfig</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;The Deployment is external, cannot create YAML deployment files&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;gateway&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">default_port</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">jina.serve.networking</span> <span class="kn">import</span> <span class="n">GrpcConnectionPool</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">GrpcConnectionPool</span><span class="o">.</span><span class="n">K8S_PORT</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">GrpcConnectionPool</span><span class="o">.</span><span class="n">K8S_PORT</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>
                <span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="n">GrpcConnectionPool</span><span class="o">.</span><span class="n">K8S_PORT_MONITORING</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_pod_args</span><span class="o">.</span><span class="n">port_monitoring</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">GrpcConnectionPool</span><span class="o">.</span><span class="n">K8S_PORT_MONITORING</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">default_port</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">deployments_addresses</span> <span class="o">=</span> <span class="n">k8s_deployments_addresses</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span>
            <span class="p">):</span>
                <span class="kn">from</span> <span class="nn">jina.serve.networking</span> <span class="kn">import</span> <span class="n">GrpcConnectionPool</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">GrpcConnectionPool</span><span class="o">.</span><span class="n">K8S_PORT</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">protocol</span><span class="p">))</span>
                <span class="p">]</span>
        <span class="n">k8s_deployment</span> <span class="o">=</span> <span class="n">K8sDeploymentConfig</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">k8s_namespace</span><span class="o">=</span><span class="n">k8s_namespace</span>
        <span class="p">)</span>

        <span class="n">configs</span> <span class="o">=</span> <span class="n">k8s_deployment</span><span class="o">.</span><span class="n">to_kubernetes_yaml</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">k8s_objects</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.yml&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_base_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k8s_object</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">k8s_objects</span><span class="p">):</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">k8s_object</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k8s_objects</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Deployment.to_kubernetes_yaml"><a class="viewcode-back" href="../../../../api/jina.orchestrate.deployments/#jina.orchestrate.deployments.Deployment.to_kubernetes_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">to_kubernetes_yaml</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k8s_namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a Jina Deployment into a set of YAML deployments to deploy in Kubernetes.</span>

<span class="sd">        If you don&#39;t want to rebuild image on Executor Hub,</span>
<span class="sd">        you can set `JINA_HUB_NO_IMAGE_REBUILD` environment variable.</span>

<span class="sd">        :param output_base_path: The base path where to dump all the YAML files</span>
<span class="sd">        :param k8s_namespace: The name of the k8s namespace to set for the configurations. If None, the name of the Flow will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k8s_namespace</span> <span class="o">=</span> <span class="n">k8s_namespace</span> <span class="ow">or</span> <span class="s1">&#39;default&#39;</span>
        <span class="c1"># the Deployment conversion needs to be done in a version without Gateway included. Deployment does quite some changes to its args</span>
        <span class="c1"># to let some of the args (like ports) go to the gateway locally. In Kubernetes, we want no gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_kubernetes_yaml</span><span class="p">(</span>
            <span class="n">output_base_path</span><span class="o">=</span><span class="n">output_base_path</span><span class="p">,</span>
            <span class="n">k8s_namespace</span><span class="o">=</span><span class="n">k8s_namespace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;K8s YAML files have been created under [b]</span><span class="si">{</span><span class="n">output_base_path</span><span class="si">}</span><span class="s1">[/]. You can use it by running [b]kubectl apply -R -f </span><span class="si">{</span><span class="n">output_base_path</span><span class="si">}</span><span class="s1">[/]&#39;</span>
        <span class="p">)</span></div>

    <span class="n">to_k8s_yaml</span> <span class="o">=</span> <span class="n">to_kubernetes_yaml</span></div>
</pre></div>
                </article>
            </div>
            <footer>
                
                <div class="related-pages">
                    
                    
                </div>
                <div class="bottom-of-page">
                    <div class="left-details">
                        <div class="copyright">
                            Copyright &#169; Jina AI Limited. All rights reserved.
                        </div><div class="last-updated">
                            Last updated on Sep 12, 2024</div>
                    </div>
                    <div class="right-details">
                        <div class="social-btns">
                            <a class='social-btn' href="https://github.com/jina-ai/jina" aria-label="GitHub"
                               target="_blank" rel="noreferrer"> <i class="fab fa-github"></i></a>
                            <a class='social-btn' href="https://discord.jina.ai" aria-label="Discord" target="_blank"
                               rel="noreferrer"> <i class="fab fa-discord"></i></a>
                            <a class='social-btn' href="https://youtube.com/c/jina-ai" aria-label="YouTube"
                               target="_blank" rel="noreferrer"> <i class="fab fa-youtube"></i></a>
                            <a class='social-btn' href="https://twitter.com/JinaAI_" aria-label="Twitter"
                               target="_blank" rel="noreferrer"> <i class="fab fa-twitter"></i></a>
                            <a class='social-btn' href="https://www.linkedin.com/company/jinaai/" aria-label="LinkedIn"
                               target="_blank" rel="noreferrer"> <i class="fab fa-linkedin"></i></a>
                        </div>
                    </div>
                </div>
                
            </footer>
        </div>
        <aside class="toc-drawer no-toc">
            
            
            
        </aside>
    </div>
</div>
<img referrerpolicy="no-referrer-when-downgrade"
     src="https://static.scarf.sh/a.png?x-pxid=2823e771-0e1e-4320-8fde-48bc48e53262"/><script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/scripts/furo.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    </body>
</html>