name: Benchmarking

on:
  push:
    branches:
      - master
    tags:
      - "v*" 

jobs:
  benchmark-tag:
    runs-on: ubuntu-latest
    if: ${{ GITHUB_REF != 'master' }}
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: benchmark-jina
          repo: jina-ai/jina-terraform
          token: ${{ secrets.JINA_DEV_BOT }}
          inputs: '{ "git_tags": ["${{ GITHUB_REF }}"], "pypi_releases": [] }'

  benchmark-master:
    runs-on: ubuntu-latest
    if: ${{ GITHUB_REF == 'master' }}
    steps:
      - run: |
          git fetch --depth=1
          INIT_FILE='jina/__init__.py'
          RELEASE_VER=$(sed -n '/^__version__/p' $INIT_FILE | cut -d \' -f2)
          LAST_VER=$(git tag -l | sort -V | tail -n1)
          COMMITS_SINCE_LAST_VER=$(git rev-list $LAST_VER..HEAD --count)
          NEXT_VER=$RELEASE_VER".dev"$COMMITS_SINCE_LAST_VER
          echo "NEXT_VER=$NEXT_VER" >> $GITHUB_ENV
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: benchmark-jina
          repo: jina-ai/jina-terraform
          token: ${{ secrets.JINA_DEV_BOT }}
          inputs: '{ "git_tags": ["${{ env.NEXT_VER }}"], "pypi_releases": [] }'